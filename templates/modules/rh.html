{% extends "base.html" %}

{% block title %}Módulo RH - Carangos S/A{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem;">
    <div>
        <h1 style="font-size: 2rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem;">
            <i class="fas fa-users" style="color: var(--warning-color);"></i> Módulo RH
        </h1>
        <p style="color: var(--text-secondary); font-size: 1.05rem;">Gestão de funcionários e folha de pagamento</p>
    </div>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary" style="width: auto;">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>
</div>

<div class="dashboard-grid" style="grid-template-columns: 1fr 2fr;">
    <!-- Employee Form -->
    <div class="glass-panel" style="padding: 1.5rem;">
        <h3>Cadastrar Funcionário</h3>
        <form method="POST">
            <div class="form-group">
                <label>Nome Completo</label>
                <input type="text" name="nome" class="form-control" required>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>CPF</label>
                    <input type="text" name="cpf" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>RG</label>
                    <input type="text" name="rg" class="form-control">
                </div>
            </div>
            <div class="form-group">
                <label>Endereço</label>
                <input type="text" name="endereco" class="form-control">
            </div>
            <div class="form-group">
                <label>Telefone</label>
                <input type="text" name="telefone" class="form-control">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Qtd. Filhos</label>
                    <input type="number" name="qtd_filhos" class="form-control" value="0" min="0">
                </div>
                <div class="form-group">
                    <label>Valor Hora (R$)</label>
                    <input type="number" name="valor_hora" class="form-control" required step="0.01">
                </div>
            </div>
            <div class="form-group">
                <label>Cargo</label>
                <select name="cargo" class="form-control">
                    <option value="Operario">Operário</option>
                    <option value="Analista">Analista</option>
                    <option value="Gerente">Gerente</option>
                    <option value="Diretor">Diretor</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Cadastrar</button>
        </form>
    </div>

    <!-- Payroll Report -->
    <div class="glass-panel" style="padding: 1.5rem;">
        <h3 style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
            <i class="fas fa-file-invoice-dollar" style="color: var(--warning-color);"></i> Folha de Pagamento
            (Simulação Mensal)
        </h3>
        <div class="alert alert-info" style="margin-bottom: 1.5rem;">
            Calculado com base em 160h normais + 10h extras (exceto gerência).
        </div>

        <div style="max-height: 500px; overflow-y: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="text-align: left; border-bottom: 1px solid var(--glass-border);">
                        <th style="padding: 0.5rem;">Nome</th>
                        <th style="padding: 0.5rem;">Cargo</th>
                        <th style="padding: 0.5rem;">Bruto</th>
                        <th style="padding: 0.5rem;">IRPF</th>
                        <th style="padding: 0.5rem;">Paga IR?</th>
                        <th style="padding: 0.5rem;">Líquido</th>
                        <th style="padding: 0.5rem;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for f in folha %}
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td style="padding: 0.5rem;">{{ f['nome'] }}</td>
                        <td style="padding: 0.5rem;">{{ f['cargo'] }}</td>
                        <td style="padding: 0.5rem;">R$ {{ "%.2f"|format(f['bruto']) }}</td>
                        <td style="padding: 0.5rem; color: var(--danger-color);">R$ {{ "%.2f"|format(f['irpf']) }}</td>
                        <td style="padding: 0.5rem;">
                            {% if f['irpf'] > 0 %}
                            <span style="color: var(--danger-color); font-weight: bold;">Sim</span>
                            {% else %}
                            <span style="color: var(--text-secondary);">Não</span>
                            {% endif %}
                        </td>
                        <td style="padding: 0.5rem; color: var(--success-color); font-weight: bold;">R$ {{
                            "%.2f"|format(f['liquido']) }}</td>
                        <td style="padding: 0.5rem; display: flex; gap: 0.5rem;">
                            <!-- Find the original employee object to get CPF -->
                            {% set func = funcionarios | selectattr("nome", "equalto", f['nome']) | first %}
                            {% if func %}
                            <button class="btn btn-sm btn-secondary"
                                onclick="openEditModal('{{ func.cpf }}', '{{ func.nome }}', '{{ func.endereco }}', '{{ func.telefone }}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <form action="{{ url_for('rh_delete', cpf=func.cpf) }}" method="POST"
                                style="display:inline;"
                                onsubmit="return confirm('Tem certeza que deseja excluir este funcionário?');">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" style="padding: 1rem; text-align: center; color: var(--text-secondary);">Nenhum
                            funcionário cadastrado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px);">
    <div class="modal-content glass-panel"
        style="margin: 10% auto; padding: 2rem; border: 1px solid var(--glass-border); width: 50%; max-width: 500px; position: relative;">
        <span class="close" onclick="closeEditModal()"
            style="position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">&times;</span>
        <h3 style="margin-bottom: 1.5rem;">Editar Funcionário</h3>
        <form id="editForm" method="POST">
            <div class="form-group">
                <label>Nome Completo</label>
                <input type="text" id="edit_nome" name="nome" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Endereço</label>
                <input type="text" id="edit_endereco" name="endereco" class="form-control">
            </div>
            <div class="form-group">
                <label>Telefone</label>
                <input type="text" id="edit_telefone" name="telefone" class="form-control">
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Salvar
                Alterações</button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function openEditModal(cpf, nome, endereco, telefone) {
        document.getElementById('editModal').style.display = "block";
        document.getElementById('editForm').action = "/rh/edit/" + cpf;
        document.getElementById('edit_nome').value = nome;
        document.getElementById('edit_endereco').value = endereco;
        document.getElementById('edit_telefone').value = telefone;
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = "none";
    }

    // Close modal if clicked outside
    window.onclick = function (event) {
        var modal = document.getElementById('editModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>
{% endblock %}