{% extends "base.html" %}

{% block title %}Terminal - Carangos S/A{% endblock %}

{% block content %}
<div class="card" style="height: calc(100vh - 200px); display: flex; flex-direction: column;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="margin: 0;">
            <i class="fas fa-terminal"></i> Terminal Interativo
        </h2>
        <div>
            <span class="badge badge-primary">{{ user }}</span>
            <span class="badge badge-success">{{ role }}</span>
        </div>
    </div>

    <div id="terminal-output" style="flex: 1; overflow-y: auto; background: rgba(0, 0, 0, 0.5); border-radius: 10px; padding: 1.5rem; font-family: 'Courier New', monospace; font-size: 0.95rem; line-height: 1.6; margin-bottom: 1rem;">
        <div class="terminal-line">
            <span class="text-primary">Carangos S/A - Terminal Interativo v1.0</span>
        </div>
        <div class="terminal-line">
            <span class="text-secondary">Digite "help" para ver os comandos disponíveis</span>
        </div>
        <div class="terminal-line">
            <span class="text-secondary">═══════════════════════════════════════</span>
        </div>
    </div>

    <div style="display: flex; gap: 0.5rem; align-items: center;">
        <span style="color: var(--success-color); font-family: 'Courier New', monospace; font-weight: bold;">$</span>
        <input 
            type="text" 
            id="terminal-input" 
            class="form-control" 
            placeholder="Digite um comando..." 
            autocomplete="off"
            style="flex: 1; font-family: 'Courier New', monospace;"
        >
        <button onclick="executeCommand()" class="btn btn-primary" style="width: auto; padding: 0.875rem 1.5rem;">
            <i class="fas fa-play"></i> Executar
        </button>
        <button onclick="clearTerminal()" class="btn btn-secondary" style="width: auto; padding: 0.875rem 1.5rem;">
            <i class="fas fa-eraser"></i> Limpar
        </button>
    </div>
</div>

<style>
.terminal-line {
    margin-bottom: 0.5rem;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.terminal-command {
    color: var(--success-color);
    font-weight: bold;
}

.terminal-output {
    color: var(--text-color);
}

.terminal-error {
    color: var(--danger-color);
}

#terminal-output::-webkit-scrollbar {
    width: 8px;
}

#terminal-output::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
}

#terminal-output::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 4px;
}

#terminal-output::-webkit-scrollbar-thumb:hover {
    background: var(--primary-hover);
}

/* Animação de digitação */
@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}

.cursor-blink {
    animation: blink 1s infinite;
}
</style>

<script>
let commandHistory = [];
let historyIndex = -1;

document.getElementById('terminal-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        executeCommand();
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (historyIndex < commandHistory.length - 1) {
            historyIndex++;
            this.value = commandHistory[historyIndex];
        }
    } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (historyIndex > 0) {
            historyIndex--;
            this.value = commandHistory[historyIndex];
        } else if (historyIndex === 0) {
            historyIndex = -1;
            this.value = '';
        }
    }
});

function executeCommand() {
    const input = document.getElementById('terminal-input');
    const command = input.value.trim();
    
    if (!command) return;
    
    // Add to history
    commandHistory.unshift(command);
    historyIndex = -1;
    
    // Display command in terminal
    addToTerminal(`<span class="terminal-command">$ ${escapeHtml(command)}</span>`);
    
    // Clear input
    input.value = '';
    
    // Send command to server
    fetch('/terminal/execute', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ command: command })
    })
    .then(response => response.json())
    .then(data => {
        if (data.type === 'clear') {
            clearTerminal();
        } else {
            addToTerminal(`<span class="terminal-output">${data.output}</span>`);
        }
        scrollToBottom();
    })
    .catch(error => {
        addToTerminal(`<span class="terminal-error">Erro ao executar comando: ${error}</span>`);
        scrollToBottom();
    });
}

function addToTerminal(html) {
    const output = document.getElementById('terminal-output');
    const line = document.createElement('div');
    line.className = 'terminal-line';
    line.innerHTML = html;
    output.appendChild(line);
}

function clearTerminal() {
    const output = document.getElementById('terminal-output');
    output.innerHTML = `
        <div class="terminal-line">
            <span class="text-primary">Carangos S/A - Terminal Interativo v1.0</span>
        </div>
        <div class="terminal-line">
            <span class="text-secondary">Digite "help" para ver os comandos disponíveis</span>
        </div>
        <div class="terminal-line">
            <span class="text-secondary">═══════════════════════════════════════</span>
        </div>
    `;
}

function scrollToBottom() {
    const output = document.getElementById('terminal-output');
    output.scrollTop = output.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Focus input on load
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('terminal-input').focus();
});
</script>
{% endblock %}
